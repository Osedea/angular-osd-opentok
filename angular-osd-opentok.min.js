"use strict";!function(){angular.module("osdOpentok",[])}(),function(){function e(e){e.put("/templates/angular-osd-opentok.html",'<div id="opentokDiv" class="video-block"><div class="subscriber-list"><div id="subscriber-{{ $index + 1 }}" ng-repeat="subscriber in getSubscribers()" ng-class="subscriber.isFullscreen ? \'main-subscriber\' : \'thumbnail-subscriber\'" ng-click="switchFullscreen(subscriber)" ng-style="subscriber.getStyle()"></div></div><div id="publisherDiv" class="publisher" ng-show="showPublisherTile" ng-class="{ \'fullscreen\' : publisher.isFullscreen }"></div><div id="publisherScreenDiv" class="publisher"></div><div class="dropup"><button id="dropdownMenu2" class="btn btn-primary" type="button" data-toggle="dropdown" aria-expanded="true">Streams ( {{ getStreamsAvailable().length + 1 }} ) <span class="caret"></span></button><ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu2"><li class="clearfix"><span>You</span><div class="pull-right inline-block"><a ng-click="showPublisherTile = !showPublisherTile"><i class="fa" ng-class="showPublisherTile ? \'fa-compress\' : \'fa-expand\'"></i></a></div></li><li class="clearfix" ng-repeat="stream in getStreamsAvailable()"><span>{{ stream.name }}</span><div class="pull-right inline-block"><a ng-click="isBeingSubscribedTo(stream) ? unsubscribe(stream) : subscribe(stream)"><i class="fa" ng-class="isBeingSubscribedTo(stream) ? \'fa-stop\' : \'fa-play\'"></i></a><a ng-click="forceDisconnect(stream)" ng-show="isModerator()"><i class="fa fa-sign-out"></i></a></div></li></ul></div></div>')}e.$inject=["$templateCache"],angular.module("osdOpentok").run(e)}(),function(){var e=angular.module("osdOpentok");e.provider("OpentokConfig",function(){var e=this,i={maxVideoSubscribers:2,maxAudioSubscribers:2,credentials:{}};return e.setConfig=function(n){return i=n,e},e.$get=function(){return i},e})}(),function(){var e=angular.module("osdOpentok");e.provider("PublisherConfig",function(){var e=this,i={width:200,height:150,name:"Me"};return e.setConfig=function(n){return i=n,e},e.$get=function(){return i},e})}(),function(){var e=angular.module("osdOpentok");e.provider("SubscriberConfig",function(){var e=this,i={width:200,height:150,name:"Me"};return e.setConfig=function(n){return i=n,e},e.$get=function(){return i},e})}(),function(){function e(e,i,n,s,r){e.config=r,e.publishingVideo=s.publishingVideo,e.showPublisherTile=!0,e.publisher=s,e.getStreamsAvailable=function(){return n.streamsAvailable},e.getSubscribers=function(){return n.subscribers},e.isBeingSubscribedTo=n.isBeingSubscribedTo,e.switchFullscreen=n.switchFullscreen,e.publishScreen=i.publishScreen,e.isModerator=i.isModerator,e.forceDisconnect=i.forceDisconnect,e.subscribe=function(s){return e.mediaAccessAllowed?n.subscribers.length>=r.maxVideoSubscribers+r.maxAudioSubscribers?(e.onSubscriberLimitReached(),void 0):(i.subscribe(s,!0),void 0):(e.onAccessRequired(),void 0)},e.unsubscribe=function(e){i.unsubscribe(e,!0)},s.onAccessAllowed=function(){e.mediaAccessAllowed=!0,e.onMediaAccessAllowed(),e.$apply()},s.onAccessDenied=function(){e.mediaAccessAllowed=!1,e.onAccessDenied(),e.$apply()}}function i(){return{restrict:"E",replace:!0,templateUrl:"/templates/angular-osd-opentok.html",controller:"LiveConsultationCtrl",controllerAs:"liveCtrl",scope:{onAccessDenied:"&",onAccessRequired:"&",onSubscriberLimitReached:"&",onMediaAccessAllowed:"&"}}}e.$inject=["$scope","SessionManager","DataManager","Publisher","OpentokConfig"],angular.module("osdOpentok").directive("liveConsultation",i).controller("LiveConsultationCtrl",e)}(),function(){function e(e,i,n){function s(){var e=1;i.isFullscreen||(e=2),r.subscribers.forEach(function(i){i.isFullScreen||(i.thumbnailCount=e++)})}var r=this;return r.subscribers=[],r.streamsAvailable=[],r.createSubscriber=function(){var e=new n(r.subscribers.length+1);return i.isFullscreen=!1,r.subscribers.push(e),e},r.isBeingSubscribedTo=function(e){return r.subscribers.some(function(i){return i.session&&i.session.stream&&i.session.stream.id==e.id})},r.removeSubscriberByStream=function(e){r.subscribers=r.subscribers.filter(function(i){return i.session.stream&&i.session.stream.id!=e.id}),r.switchFullscreen()},r.getStreamByConnection=function(e){var i=r.streamsAvailable.filter(function(i){return i.connection.id===e.id});return i.length?i[0]:null},r.removeStreamByConnection=function(e){var i=r.getStreamByConnection(e);i&&(r.removeSubscriberByStream(i),r.streamsAvailable=r.streamsAvailable.filter(function(e){return i.id!=e.id})),r.switchFullscreen()},r.switchFullscreen=function(n){e(function(){i.isFullscreen=!1,r.subscribers.forEach(function(e){e.isFullscreen=!1}),n?n.isFullscreen=!0:r.subscribers.length?r.subscribers[0].isFullscreen=!0:i.isFullscreen=!0,s()})},r}e.$inject=["$timeout","Publisher","Subscriber"],angular.module("osdOpentok").service("DataManager",e)}(),function(){function e(e){var i=this;return i.onAccessAllowed=null,i.onAccessDenied=null,i.session=null,i.publishingVideo=!1,i.stream=null,i.isFullscreen=!0,i.divId="publisherDiv",i.options={width:this.isFullscreen?"100%":e.width+"px",height:this.isFullscreen?"100%":e.height+"px",publishVideo:!0,publishAudio:!0,insertMode:"append"},i.setSession=function(e){i.session=e,i.session.on({accessAllowed:i.onAccessAllowed,accessDenied:i.onAccessDenied})},i.toggleVideo=function(){return i.session?(i.session.publishVideo(!i.publishingVideo),i.publishingVideo=!i.publishingVideo,i.publishingVideo):void 0},i}e.$inject=["PublisherConfig"],angular.module("osdOpentok").factory("Publisher",e)}(),function(){function e(e,i,n,s,r){function t(){a.on({sessionDisconnected:g,streamCreated:b,streamDestroyed:h,connectionDestroyed:d,signal:function(e){"signal:subscribe"==e.type&&f(e),"signal:unsubscribe"==e.type&&p(e)}})}function o(){var e=Math.max(document.documentElement.clientHeight,window.innerHeight||0),i=document.getElementById("opentokDiv");i.style.height=e-66+"px"}function c(){var e=new XMLHttpRequest;XMLHttpRequest.prototype=Object.getPrototypeOf(e)}function u(e){e&&console.log("Error: ",e)}var l=this,a=null;l.init=function(){o(),c(),s.screenshare&&OT.registerScreenSharingExtension("chrome",s.screenshare.extensionId),a=OT.initSession(s.credentials.apiKey,s.credentials.sid,u),t(),l.publish()},l.publish=function(){a.connect(s.credentials.token,function(e){u(e),i.options.name=s.credentials.name,i.setSession(OT.initPublisher(i.divId,i.options,u)),a.publish(i.session,u)})},l.publishScreen=function(){OT.checkScreenSharingCapability(function(e){if(e.supported&&e.extensionRegistered!==!1)if(e.extensionInstalled===!1)alert("Please install the screen sharing extension and load this page over HTTPS.");else{var i=OT.initPublisher("publisherScreenDiv",{videoSource:"screen",name:"Screenshare"},u);a.publish(i,u)}else alert("This browser does not support screen sharing.")})},l.subscribe=function(i,n){var t=null;e(function(){t=r.createSubscriber()}),e(function(){t.session=a.subscribe(i,t.divId,t.options),r.subscribers.length>s.maxVideoSubscribers&&t.session.subscribeToVideo(!1),n&&a.signal({type:"subscribe",to:i.connection})},50)},l.unsubscribe=function(e,i){i&&a.signal({type:"unsubscribe",to:e.connection}),a.unsubscribe(e),r.removeSubscriberByStream(e)},l.forceDisconnect=function(e){l.isModerator()&&(r.removeSubscriberByStream(),a.forceUnpublish(e),a.forceDisconnect(e.connection))},l.isModerator=function(){return a&&1==a.capabilities.forceDisconnect};var b=function(i){e(function(){r.streamsAvailable.push(i.stream)})},d=function(i){e(function(){r.removeStreamByConnection(i.connection)})},h=function(i){e(function(){r.removeStreamByConnection(i.stream.connection)})},f=function(i){e(function(){l.subscribe(r.getStreamByConnection(i.from),!1)})},p=function(e){var i=r.getStreamByConnection(e.from);l.unsubscribe(i,!1)},g=function(){e(function(){r.subscribers=[],r.streamsAvailable=[]})};return l}e.$inject=["$timeout","Publisher","Subscriber","OpentokConfig","DataManager"],angular.module("osdOpentok").service("SessionManager",e)}(),function(){function e(e){return function(i){var n=this;n.session=null,n.isFullscreen=1===i,n.thumbnailCount=i,n.divId="subscriber-"+i,n.options={width:n.isFullscreen?"100%":e.width+"px",height:n.isFullscreen?"100%":e.height+"px",subscribeToVideo:!0,subscribeToAudio:!0,insertMode:"replace"},n.getStyle=function(){var i=-((e.width+5)*n.thumbnailCount);return{width:n.isFullscreen?"100%":e.width+"px",height:n.isFullscreen?"100%":e.height+"px","margin-left":n.isFullscreen?0:i+"px"}},n.toggleVideo=function(){return n.session?(n.session.subscribeToVideo(!n.subscribingToVideo),n.subscribingToVideo=!n.subscribingToVideo,n.subscribingToVideo):void 0}}}e.$inject=["SubscriberConfig"],angular.module("osdOpentok").service("Subscriber",e)}();