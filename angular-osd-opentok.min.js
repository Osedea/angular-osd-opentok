"use strict";!function(){angular.module("osdOpentok",["ngLodash"])}(),function(){function e(e){e.put("/templates/angular-osd-opentok.html",'<div id="opentokDiv" class="video-block"><div class="subscriber-list"><div id="subscriber-{{ $index + 1 }}"ng-repeat="subscriber in subscribers"ng-class="subscriber.isFullscreen ? \'main-subscriber\' : \'thumbnail-subscriber\'"ng-click="switchFullscreen(subscriber)"ng-style="getSubscriberStyle(subscriber)"></div></div><div id="publisherDiv"ng-show="showPublisherTile"ng-class="{ \'fullscreen\' : publisher.isFullscreen }"class="publisher"></div><div class="dropup"><button class="btn btn-primary" type="button" id="dropdownMenu2" data-toggle="dropdown"aria-expanded="true">Users ( {{ streamsAvailable.length + 1 }} ) <span class="caret"></span></button><ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu2"><li><a ng-click="showPublisherTile = !showPublisherTile"ng-disabled="isSubscribing() && !isBeingSubscribedTo(stream)"><span>You</span><div class="pull-right"><i class="fa" ng-class="showPublisherTile ? \'fa-compress\' : \'fa-expand\'"></i></div></a></li><li ng-repeat="stream in streamsAvailable | streamsList:isModerator"><a ng-click="isBeingSubscribedTo(stream) ? forceDisconnect(stream) : subscribe(stream)"ng-show="isModerator"><span>{{ stream.name }}</span><div class="pull-right"><i class="fa" ng-class="isBeingSubscribedTo(stream) ? \'fa-stop\' : \'fa-play\'"></i></div></a></li></ul></div></div>')}e.$inject=["$templateCache"],angular.module("osdOpentok").run(e)}(),function(){var e=angular.module("osdOpentok");e.provider("OpentokConfig",function(){var e=this,i={maxSubscribers:2,credentials:{}};return e.setConfig=function(s){return i=s,e},e.$get=function(){return i},e})}(),function(){var e=angular.module("osdOpentok");e.provider("PublisherConfig",function(){var e=this,i={width:200,height:150,name:"Me"};return e.setConfig=function(s){return i=s,e},e.$get=function(){return i},e})}(),function(){var e=angular.module("osdOpentok");e.provider("SubscriberConfig",function(){var e=this,i={width:200,height:150,name:"Me"};return e.setConfig=function(s){return i=s,e},e.$get=function(){return i},e})}(),function(){function e(e,i,s,n,r){function t(){i(function(){e.mediaAccessAllowed=!0})}function o(){e.mediaAccessAllowed=!1,e.onAccessDenied()}function c(s){i(function(){var i=s.stream;h(i.connection)||e.streamsAvailable.push(i)})}function u(i){d(i.stream.connection),e.$apply()}function l(i){d(i.connection),e.$apply()}function a(i){var s=h(i.from);w.subscribe(s,!1),e.$apply()}function b(){v.disconnect(),e.streamsAvailable=[],e.subscribers=[],e.$apply()}function d(i){var s=h(i);s&&(p(s),e.streamsAvailable=e.streamsAvailable.filter(function(e){return s.id!=e.id})),e.subscribers.length?e.switchFullscreen(e.subscribers[0]):n.isFullscreen=!0}function p(i){e.subscribers=e.subscribers.filter(e.subscribers,function(e){return e.session.stream&&e.session.stream.id!=i.id})}function h(i){return e.streamsAvailable.filter(e.streamsAvailable,function(e){return e.connection.id===i.id}).pop()}function f(){v.on({streamCreated:c,streamDestroyed:u,connectionDestroyed:l,signal:function(e){"signal:subscribe"==e.type&&a(e),"signal:disconnect"==e.type&&b(e)}})}function g(){n.session.on({accessAllowed:t,accessDenied:o})}function m(e){e&&console.log("Error: ",e)}var v=null,w=this,y=document.getElementById("opentokDiv");y.style.height=parseInt(3*y.offsetWidth/5)+"px",e.config=r,e.publishingVideo=n.publishingVideo,e.isModerator=!0,e.showPublisherTile=!0,e.publisher=n,e.streamsAvailable=[],e.subscribers=[],e.init=function(){var e=new XMLHttpRequest;XMLHttpRequest.prototype=Object.getPrototypeOf(e),OT.registerScreenSharingExtension("chrome",r.screenshare.extensionId),v=OT.initSession(r.credentials.apiKey,r.credentials.sid,function(e){m(e)}),f(),w.publish()},e.screenshare=function(){OT.checkScreenSharingCapability(function(e){e.supported&&e.extensionRegistered!==!1?e.extensionInstalled===!1?alert("Please install the screen sharing extension and load this page over HTTPS."):w.publish():alert("This browser does not support screen sharing.")})},w.publish=function(){v.connect(r.credentials.token,function(e){m(e),n.session=OT.initPublisher(n.divId,n.options,m),g(),v.publish(n.session,m)})},w.subscribe=function(r,t){var o=new s(e.subscribers.length+1);i(function(){n.isFullscreen=!1,e.subscribers.push(o)}),i(function(){o.session=v.subscribe(r,o.divId,o.options),t&&v.signal({type:"subscribe",to:r.connection})},100)},w.unsubscribe=function(e,i){i&&v.signal({type:"disconnect",to:e.connection}),v.unsubscribe(e)},w.forceDisconnect=function(e){1==v.capabilities.forceDisconnect&&(v.forceUnpublish(e),v.forceDisconnect(e))},w.isModerator=function(){return 1==v.capabilities.forceDisconnect},e.subscribe=function(i){if(!e.mediaAccessAllowed)return e.onAccessRequired(),void 0;if(e.isModerator)return e.subscribers.length>=r.maxSubscribers?(e.onSubscriberLimitReached(),void 0):(w.subscribe(i,!0),void 0)},e.switchFullscreen=function(i){e.subscribers.forEach(function(e){e.isFullscreen=!1}),n.isFullscreen=!1,i.isFullscreen=!0},e.getSubscriberStyle=function(e){return e.getStyle()},e.forceDisconnect=function(e){w.unsubscribe(e,!0),p(e)},e.isBeingSubscribedTo=function(i){return e.subscribers.some(function(e){return e.session&&e.session.stream&&e.session.stream.id==i.id})}}function i(){return{restrict:"E",replace:!0,templateUrl:"/templates/angular-osd-opentok.html",controller:"LiveConsultationCtrl",controllerAs:"liveCtrl",scope:{onAccessDenied:"&",onAccessRequired:"&",onSubscriberLimitReached:"&",mediaAccessAllowed:"="}}}e.$inject=["$scope","$timeout","Subscriber","Publisher","OpentokConfig"],angular.module("osdOpentok").directive("liveConsultation",i).controller("LiveConsultationCtrl",e)}(),function(){function e(e){var i=this;return i.session=null,i.publishingVideo=!1,i.stream=null,i.isFullscreen=!0,i.divId="publisherDiv",i.options={width:this.isFullscreen?"100%":e.width+"px",height:this.isFullscreen?"100%":e.height+"px",publishVideo:!0,publishAudio:!0,insertMode:"append",name:e.name},i.toggleVideo=function(){return i.session?(i.session.publishVideo(!i.publishingVideo),i.publishingVideo=!i.publishingVideo,i.publishingVideo):void 0},i}e.$inject=["PublisherConfig"],angular.module("osdOpentok").factory("Publisher",e)}(),function(){function e(e){return function(i){var s=this;s.isFullscreen=1===i,s.session=null,s.count=i,s.divId="subscriber-"+i,s.options={width:s.isFullscreen?"100%":e.width+"px",height:s.isFullscreen?"100%":e.height+"px",subscribeToVideo:!0,subscribeToAudio:!0,insertMode:"replace"},s.getStyle=function(){var i=(-e.width+5)*s.count;return{width:s.isFullscreen?"100%":e.width+"px",height:s.isFullscreen?"100%":e.height+"px","margin-left":s.isFullscreen?0:i+"px"}},s.toggleVideo=function(){return s.session?(s.session.subscribeToVideo(!s.subscribingToVideo),s.subscribingToVideo=!s.subscribingToVideo,s.subscribingToVideo):void 0}}}e.$inject=["SubscriberConfig"],angular.module("osdOpentok").service("Subscriber",e)}();