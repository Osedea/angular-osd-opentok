"use strict";!function(){angular.module("osdOpentok",[])}(),function(){function e(e){e.put("/templates/angular-osd-opentok.html",'<div id="opentokDiv" class="video-block"><div class="subscriber-list"><div id="subscriber-{{ $index + 1 }}" ng-repeat="subscriber in getSubscribers()" ng-class="subscriber.isFullscreen ? \'main-subscriber\' : \'thumbnail-subscriber\'" ng-click="switchFullscreen(subscriber)" ng-style="subscriber.getStyle()"></div></div><div id="screenshareDiv" class="screenshare"></div><div id="publisherDiv" class="publisher" ng-show="showPublisherTile" ng-class="{ \'fullscreen\' : isFullscreen() }"></div><button class="btn btn-primary btn-screenshare" ng-click="toggleScreenshare()" ng-show="screenshareIsSupported()">{{ getScreensharePublisher() ? \'Stop Sharing\' : \'Share Screen\' }}</button><div class="dropup"><button id="dropdownMenu2" class="btn btn-primary" type="button" data-toggle="dropdown" aria-expanded="true">Streams ( {{ getStreamsAvailable().length + 1 }} ) <span class="caret"></span></button><ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu2"><li class="clearfix"><span>You</span><div class="pull-right inline-block"><a ng-click="showPublisherTile = !showPublisherTile"><i class="fa" ng-class="showPublisherTile ? \'fa-compress\' : \'fa-expand\'"></i></a></div></li><li class="clearfix" ng-repeat="stream in getStreamsAvailable()"><span>{{ stream.name }}</span><div class="pull-right inline-block"><a ng-click="isBeingSubscribedTo(stream) ? unsubscribe(stream) : subscribe(stream)"><i class="fa" ng-class="isBeingSubscribedTo(stream) ? \'fa-stop\' : \'fa-play\'"></i></a><a ng-click="forceDisconnect(stream)" ng-show="isModerator()"><i class="fa fa-sign-out"></i></a></div></li></ul></div></div>')}e.$inject=["$templateCache"],angular.module("osdOpentok").run(e)}(),function(){var e=angular.module("osdOpentok");e.provider("OpentokConfig",function(){var e=this,n={maxVideoSubscribers:2,maxAudioSubscribers:2,credentials:{}};return e.setConfig=function(i){return n=i,e},e.$get=function(){return n},e})}(),function(){var e=angular.module("osdOpentok");e.provider("PublisherConfig",function(){var e=this;return e.config={width:200,height:150,name:"Me",onMediaAccessAllowed:null,onMediaAccessDenied:null},e.setConfig=function(n){return e.config=n,e},e.$get=function(){return e.config},e})}(),function(){var e=angular.module("osdOpentok");e.provider("SubscriberConfig",function(){var e=this,n={width:200,height:150,name:"Me"};return e.setConfig=function(i){return n=i,e},e.$get=function(){return n},e})}(),function(){angular.module("osdOpentok").constant("OPENTOK",{SCREENSHARE:{UNSUPPORTED:1,EXTENSION_REQUIRED:2,SUPPORTED:3}})}(),function(){function e(e,n,i,s,r){e.config=s,e.showPublisherTile=!0,e.getStreamsAvailable=i.getStreamsAvailable,e.getSubscribers=i.getSubscribers,e.isFullscreen=function(){var e=i.getPublishers();return e.length?e[0].isFullscreen:!1},e.getScreensharePublisher=function(){var e=i.getPublishers();return e.length?e[1]:null},e.isBeingSubscribedTo=i.isBeingSubscribedTo,e.switchFullscreen=i.switchFullscreen,e.toggleScreenshare=n.toggleScreenshare,e.isModerator=n.isModerator,e.forceDisconnect=n.forceDisconnect,e.screenshareIsSupported=function(){return n.screenshareAbility==r.SCREENSHARE.SUPPORTED},e.subscribe=function(r){return n.getMediaAccessAllowed()?i.subscribers.length>=s.maxVideoSubscribers+s.maxAudioSubscribers?(e.onSubscriberLimitReached(),void 0):(n.subscribe(r,!0),void 0):(e.onAccessRequired(),void 0)},e.unsubscribe=function(e){n.unsubscribe(e,!0)}}function n(){return{restrict:"E",replace:!0,templateUrl:"/templates/angular-osd-opentok.html",controller:"LiveConsultationCtrl",controllerAs:"liveCtrl",scope:{onAccessRequired:"&",onSubscriberLimitReached:"&"}}}e.$inject=["$scope","SessionManager","DataManager","OpentokConfig","OPENTOK"],angular.module("osdOpentok").directive("liveConsultation",n).controller("LiveConsultationCtrl",e)}(),function(){function e(e,n,i){function s(){var e=2;r.subscribers.forEach(function(n){n.isFullscreen||(n.thumbnailCount=e++)})}var r=this;return r.subscribers=[],r.publishers=[],r.streamsAvailable=[],r.getSubscribers=function(){return r.subscribers},r.getPublishers=function(){return r.publishers},r.getStreamsAvailable=function(){return r.streamsAvailable},r.createPublisher=function(e){var i=new n(e);return e?i.setScreenshareOptions():i.setOptions(),r.publishers.push(i),i},r.createSubscriber=function(){var e=new i(r.subscribers.length+1);return r.publishers[0].isFullscreen=!1,r.subscribers.push(e),e},r.isBeingSubscribedTo=function(e){return e?r.subscribers.some(function(n){return n.session&&n.session.stream&&n.session.stream.id==e.id}):void 0},r.removeSubscriberByStream=function(e){e&&(r.subscribers=r.subscribers.filter(function(n){return n.session.stream&&n.session.stream.id!=e.id}),r.switchFullscreen())},r.getStreamByConnection=function(e){if(e){var n=r.streamsAvailable.filter(function(n){return n.connection.id===e.id});return n.length?n[0]:null}},r.removeStreamByConnection=function(e){if(e){var n=r.getStreamByConnection(e);n&&(r.removeSubscriberByStream(n),r.streamsAvailable=r.streamsAvailable.filter(function(e){return n.id!=e.id})),r.switchFullscreen()}},r.switchFullscreen=function(n){n&&n.isFullscreen||e(function(){r.subscribers.forEach(function(e){e.isFullscreen=n&&n.divId===e.divId}),r.publishers[0].isFullscreen=!n||!r.subscribers.length,s()})},r}e.$inject=["$timeout","Publisher","Subscriber"],angular.module("osdOpentok").service("DataManager",e)}(),function(){function e(e,n){return function(i){var s=this;return s.session=null,s.publishingVideo=!1,s.stream=null,s.isFullscreen=!0,s.divId=i?"screenshareDiv":"publisherDiv",s.options={},s.setOptions=function(){s.options={name:n.credentials.name,width:s.isFullscreen?"100%":e.width+"px",height:s.isFullscreen?"100%":e.height+"px",publishVideo:!0,publishAudio:!0,insertMode:"append"}},s.setScreenshareOptions=function(){s.options={name:"Screenshare",width:s.isFullscreen?"100%":e.width+"px",height:s.isFullscreen?"100%":e.height+"px",insertMode:"append",videoSource:"screen"}},s.toggleVideo=function(){return s.session?(s.session.publishVideo(!s.publishingVideo),s.publishingVideo=!s.publishingVideo,s.publishingVideo):void 0},s}}e.$inject=["PublisherConfig","OpentokConfig"],angular.module("osdOpentok").factory("Publisher",e)}(),function(){function e(e,n,i,s){function r(){b.on({sessionDisconnected:m,streamCreated:d,streamDestroyed:g,connectionDestroyed:h,signal:function(e){"signal:subscribe"==e.type&&f(e),"signal:unsubscribe"==e.type&&p(e)}})}function t(e){e.session.on({accessAllowed:function(){a.mediaAccessAllowed=!0,n.onMediaAccessAllowed()},accessDenied:n.onMediaAccessDenied})}function o(){n.screenshare&&OT.registerScreenSharingExtension("chrome",n.screenshare.extensionId),OT.checkScreenSharingCapability(function(e){a.screenshareAbility=e.supported&&e.extensionRegistered!==!1?e.extensionInstalled===!1?s.SCREENSHARE.EXTENSION_REQUIRED:s.SCREENSHARE.SUPPORTED:s.SCREENSHARE.UNSUPPORTED})}function c(){var e=Math.max(document.documentElement.clientHeight,window.innerHeight||0),n=document.getElementById("opentokDiv");n.style.height=e-66+"px"}function u(){var e=new XMLHttpRequest;XMLHttpRequest.prototype=Object.getPrototypeOf(e)}function l(e){e&&console.log("Error: ",e)}var a=this,b=null;a.screenshareAbility=null,a.mediaAccessAllowed=!1,a.init=function(){c(),u(),o(),b=OT.initSession(n.credentials.apiKey,n.credentials.sid,l),r(),b.connect(n.credentials.token,function(e){l(e),a.addPublisherToSession(!1)})},a.addPublisherToSession=function(n){return n&&a.screenshareAbility===s.UNSUPPORTED?(alert("This browser does not support screen sharing."),void 0):n&&a.screenshareAbility===s.EXTENSION_REQUIRED?(alert("Please install the screen sharing extension and load this page over HTTPS."),void 0):(e(function(){var e=i.createPublisher(n);e.session=OT.initPublisher(e.divId,e.options,l),t(e),b.publish(e.session,l)}),void 0)},a.toggleScreenshare=function(){i.publishers.length>1?(b.unpublish(i.publishers[1].session),i.publishers.splice(1,1)):a.addPublisherToSession(!0)},a.subscribe=function(s,r){var t=null;e(function(){t=i.createSubscriber()}),e(function(){t.session=b.subscribe(s,t.divId,t.options),i.subscribers.length>n.maxVideoSubscribers&&t.session.subscribeToVideo(!1),r&&b.signal({type:"subscribe",to:s.connection})},50)},a.unsubscribe=function(e,n){n&&b.signal({type:"unsubscribe",to:e.connection}),b.unsubscribe(e),i.removeSubscriberByStream(e)},a.forceDisconnect=function(e){a.isModerator()&&(i.removeSubscriberByStream(),b.forceUnpublish(e),b.forceDisconnect(e.connection))},a.isModerator=function(){return b&&1==b.capabilities.forceDisconnect},a.getMediaAccessAllowed=function(){return a.mediaAccessAllowed};var d=function(n){e(function(){i.streamsAvailable.push(n.stream)})},h=function(n){e(function(){i.removeStreamByConnection(n.connection)})},g=function(n){e(function(){i.removeStreamByConnection(n.stream.connection)})},f=function(n){e(function(){a.subscribe(i.getStreamByConnection(n.from),!1)})},p=function(e){var n=i.getStreamByConnection(e.from);a.unsubscribe(n,!1)},m=function(){e(function(){i.subscribers=[],i.streamsAvailable=[]})};return a}e.$inject=["$timeout","OpentokConfig","DataManager","OPENTOK"],angular.module("osdOpentok").service("SessionManager",e)}(),function(){function e(e){return function(n){var i=this;i.session=null,i.isFullscreen=1===n,i.thumbnailCount=n,i.divId="subscriber-"+n,i.options={width:i.isFullscreen?"100%":e.width+"px",height:i.isFullscreen?"100%":e.height+"px",subscribeToVideo:!0,subscribeToAudio:!0,insertMode:"replace"},i.getStyle=function(){var n=-((e.width+5)*i.thumbnailCount);return{width:i.isFullscreen?"100%":e.width+"px",height:i.isFullscreen?"100%":e.height+"px","margin-left":i.isFullscreen?0:n+"px","z-index":i.isFullscreen?1:10}},i.toggleVideo=function(){return i.session?(i.session.subscribeToVideo(!i.subscribingToVideo),i.subscribingToVideo=!i.subscribingToVideo,i.subscribingToVideo):void 0}}}e.$inject=["SubscriberConfig"],angular.module("osdOpentok").service("Subscriber",e)}();